{% extends "base.html" %}
{% load i18n %}
{% block styles %}
	<link href="/css/increment-asset.css" rel="stylesheet">
{% endblock %}
{% block content %}
<div class="contentpanel no-padding" style="background: #828283">
	<div class="col-md">
		<div class="panel panel-primary">
			<div class="panel-heading">
				<h4 class="panel-title"
					style="text-align: center; line-height: 10px">{% trans 'ĐÁNH GIÁ LẠI TÀI SẢN' %}</h4>
			</div>
			<form method="post" novalidate="novalidate" id="evaluationAsset">
				<input type="hidden" name = "txtAssetID" id ="txtAssetID">
				{% csrf_token %}
				<input type="hidden" name="hd_cost_amount" id="hd_cus_amount">
				<div class="panel-body">
					{% if has_error %}
						<div class="panel">
							<label class="error">{{ has_error }}</label>
						</div>
					{% endif %}
					<div class="row row-pad-5">
						<div class="alert alert-info">
							<div class="row">
								<div class="col-lg-3">
									<div class="form-group">
										<label class="control-label"> {% trans 'Đơn vị' %} </label>
										<select id="slDept" class="form-control chosen-select"
											data-placeholder="{% trans 'Đơn vị' %}" name = "slDept" required="required">
											<option value=""></option>
											{% for dept in depts %}
												<option value="{{ dept.id }}">{{ dept.code }} - {{ dept.name }}</option>
											{% endfor%}
										</select>
										<label for="slDept" class="error" style="display: none;">{% trans 'Trường không được để trống' %}</label>
									</div>
									
								</div>
								<div class="col-lg-3">
									<div class="form-group">
										<label class="control-label"> {% trans 'Kho' %} </label>
										<select id="slStock" class="form-control chosen-select"
											data-placeholder="{% trans 'Kho' %}" 
											name = "slStock" disabled="disabled" required="required">
											<option value=""></option>
										</select>
										<label for="slStock" class="error" style="display: none;">{% trans 'Trường không được để trống' %}</label>
									</div>
									
								</div>
								<div class="col-lg-3">
									<div class="form-group">
										<label class="control-label"> {% trans 'Số thẻ TSCD' %} </label>
										<select id="slSerial" class="form-control chosen-select"
											data-placeholder="{% trans 'Số thẻ TSCĐ' %}" 
											name = "slSerial" disabled="disabled" required="required">
											<option value=""></option>
											<option value="United States">TTVTT</option>
										</select>
										<label for="slSerial" class="error" style="display: none;">{% trans 'Trường không được để trống' %}</label>
									</div>
									
								</div>
								
								<div class="col-lg-3">
									<div class="form-group">
										<label class="control-label"> {% trans 'Lý do' %} </label>
										<select id="slReason" class="form-control chosen-select"
											data-placeholder="{% trans 'Lý do' %}" 
											name = "slReason" required="required">
											<option value=""></option>
											{% for reason in reasons_inc %}
												<option value="{{ reason.id }}">{{ reason.code }} - {{ reason.name }}</option>
											{% endfor%}
											{% for reason in reasons_dec %}
												<option value="{{ reason.id }}">{{ reason.code }} - {{ reason.name }}</option>
											{% endfor%}
										</select>
										<label for="slReason" class="error" style="display: none;">{% trans 'Trường không được để trống' %}</label>
									</div>
								</div>
							</div>
							
							<div class="row">
								<div class="col-lg-3">
									<div class="form-group">
										<label class="control-label"> {% trans 'Giá trị còn lại cũ' %}</label>
										<input type="text" id="current-remain-amount" 
											placeholder="{% trans 'Giá trị còn lại cũ' %}" class="form-control" disabled="disabled">
									</div>
								</div>
							
								<div class="col-lg-3">
									<label>{% trans 'Thời gian sử dụng cũ' %}</label>
									<input type="text" id="current-txtInterval" placeholder=" {% trans 'Thời gian sử dụng cũ' %}" class="form-control" disabled="disabled">
								</div>
							
								<div class="col-lg-3">
									<div class="form-group">
									<label class="control-label"> {% trans 'Trạng thái cũ' %} </label>
									<select id="current-slState" class="form-control chosen-select"
										data-placeholder="{% trans 'Trạng thái cũ...' %}" disabled="disabled">
										<option value=""></option>
										{% for state in states%}
											<option value="{{ state.id }}">{{ state.code }} - {{ state.name }}</option>
										{% endfor %}
									</select>
								</div>
								</div>
							
								<div class="col-lg-3">
									<div class="form-group">
										<label class="control-label">{% trans 'Ngày đánh giá lại tài sản' %}</label>
										<div class="input-group">
											<input type="text" class="form-control"
												data-provide="datepicker" data-date-format="dd/mm/yy" placeholder="{% trans 'Ngày đánh giá lại tài sản' %}" id="dt_evalution"
												name = "dt_evalution" required>
											<span class="input-group-addon"><i class="fa fa-calendar"></i></span>
										</div>
									</div>
								</div>
						</div>
						
						<div class="row">
							<div class="col-lg-4">
								<div class="form-group">
									<label class="control-label"> {% trans 'Giá trị còn lại' %}</label>
									<input type="text" name="txtRemainAmount" id="remain-amount" 
										placeholder="{% trans 'Giá trị còn lại' %}" class="form-control numberic" required maxlength="20">
								</div>
							</div>
							
							<div class="col-lg-4">
								<label>{% trans 'Thời gian sử dụng' %}</label>
								<input type="text" id="txtInterval" name="txtInterval" placeholder=" {% trans 'Thời gian sử dụng...' %}" class="form-control numberic" required maxlength="2">
							</div>
							
							<div class="col-lg-4">
								<div class="form-group">
									<label class="control-label"> {% trans 'Trạng thái' %} </label>
									<select id="slState" name="slState"class="form-control chosen-select"
										data-placeholder="{% trans 'Trạng thái ...' %}">
										<option value=""></option>
										{% for state in states%}
											<option value="{{ state.id }}">{{ state.code }} - {{ state.name }}</option>
										{% endfor %}
									</select>
								</div>
							</div>
							
						</div>
						
						<div class="row">
							<div class="col-lg">
								<div class="form-group">
										<textarea class="form-control" id="txtNote" name="txtNote" rows="5"
											placeholder="{% trans 'Ghi chú' %}" required maxlength="100"></textarea>
								</div>
							</div>
						</div>
						</div>
						
						
					</div>
					
					<div class="row">
						<div class="col-sm col-sm-offset-5">
							<!-- <button class="btn btn-primary">In biên bản</button> -->
							<button class="btn btn-primary" onclick="return onSubmitFormEvaluation();">{% trans 'Thực hiện' %}</button>
						</div>
					</div>
				</div>
				<!-- panel body-->
			</form>
		</div>
		<!-- panel -->
	</div>
</div>
{% endblock %} 
{% block scripts %}
<script src="/js/jquery-1.10.2.min.js"></script>
<script src="/js/jquery-migrate-1.2.1.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/modernizr.min.js"></script>
<script src="/js/jquery.sparkline.min.js"></script>
<script src="/js/toggles.min.js"></script>
<script src="/js/retina.min.js"></script>
<script src="/js/jquery.cookies.js"></script>

<script src="/js/jquery.autogrow-textarea.js"></script>
<script src="/js/jquery.maskedinput.min.js"></script>
<script src="/js/chosen.jquery.min.js"></script>
<script src="/js/jquery-ui-1.10.3.min.js"></script>
<script src="/js/jquery.validate.min.js"></script>
<script src="/js/jquery.numeric.js"></script>

<script src="/js/jquery.formatCurrency.vi-VN.js"></script>
<script src="/js/jquery.formatCurrency-1.4.0.js"></script>

<script src="/js/custom.js"></script>
<script src="/js/loading.js"></script>
<script>
var tid;
$(document).ready(function(){
// Chosen Select
	$(".chosen-select").chosen({
		'width' : '100%',
		'white-space' : 'nowrap'
	});
	// Date Picker
	$('#dt_evalution').datepicker({dateFormat: 'dd/mm/yy',maxDate: '0',});
	$("#dt_evalution").datepicker("setDate",new Date());
	// Input Masks
	$("#dt_evalution").mask("99/99/9999");
	
	$( "#slDept" ).change(function() {
		$(".error[for][for='slDept']").hide();
		clearVal('dept');
		onGetStock($(this).find('option:selected').val());
	});
	
	$( "#slStock" ).change(function() {
		$(".error[for][for='slStock']").hide();
		clearVal('stock');
		onGetCode($(this).find('option:selected').val());
	});
	$( "#slSerial" ).change(function() {
		$(".error[for][for='slSerial']").hide();
		clearVal('serial');
		var original = $(this).find('option:selected').attr('original-value');
		var remain = $(this).find('option:selected').attr('remain-value');
		var asset_id = $(this).find('option:selected').attr('asset-id');
		var state_id = $(this).find('option:selected').attr('state-id');
		var state_name = $(this).find('option:selected').attr('state-name');
		var interval = $(this).find('option:selected').attr('interval');
		$("#current-remain-amount").val(remain);
		$("#current-remain-amount").formatCurrency();
		$("#current-txtInterval").val(interval);
		$("#txtAssetID").val(asset_id);
		
		//checked slState
		$('#current-slState').val(state_id);
		
		$('#current-slState').chosen('destroy');
		$('#current-slState').chosen();
	});
	tid = setTimeout(hideNotification, 2000);
	
	$('#remain-amount').blur(function()
	{
		$(this).attr('maxlength','20');
		var temp=($(this).val()).toString();
		$("#hd_cus_amount").val(temp);
		$(this).formatCurrency();
	});
	$('#remain-amount').focus(function() 
	{
		$(this).attr('maxlength','15');
		$(this).val($("#hd_cus_amount").val());
	}); 
	
	//validate
	$.validator.setDefaults({ ignore: ":hidden:not(select)" })
});

function hideNotification()
{
	if($("#alert-success")!=null)
		$("#alert-success").remove();
	clearTimeout(tid);
}
function onSubmitFormEvaluation()
{
	var $valid = jQuery('#evaluationAsset').valid();
	if(!$valid) 
	{
		$validator.focusInvalid();
		return false;
	}
	jQuery('#evaluationAsset').submit();
	
}
function onGetCode(stock_id)
{
	//show loading
	$.fn.loading.show();
	
	var csrftoken = $.cookie('csrftoken');
	var posting = $.post("/get-list-serial"+"/"+stock_id.toString()+"/", {
		'csrfmiddlewaretoken' : csrftoken,
	});
	posting.done(function(data) 
	{
		serials = data.serials;
		if(stocks.length>0)
			$('#slSerial').prop("disabled", false);
		$('#slSerial option[value!=""]').remove();
		for(var i=0;i<serials.length ;i++)
		{
			serial = serials[i];
			option = $("<option></option>")
			option.attr("value",serial.id)
			option.attr("original-value",serial.original_value)
			option.attr("remain-value",serial.remain_value)
			option.attr("asset-id",serial.asset)
			option.attr("state-id",serial.state)
			option.attr("state-name",serial.name)
			option.attr("interval",serial.interval)
			option.text(serial.serial+"-"+serial.name)
			$('#slSerial').append(option)
		}
		$('#slSerial').chosen('destroy');
		$('#slSerial').prop("selectedIndex", -1);
		$('#slSerial').chosen();
		
		//hide loading
		$.fn.loading.hide();
	});
}
function onGetStock(dept_id)
{
	//show loading
	$.fn.loading.show();
	
	var csrftoken = $.cookie('csrftoken');
	var posting = $.post("/get-list-stock"+"/"+dept_id.toString()+"/", {
		'csrfmiddlewaretoken' : csrftoken,
	});
	posting.done(function(data) 
	{
		//alert(JSON.stringify(data))
		stocks = data.stocks
		if(stocks.length>0)
			$('#slStock').prop("disabled", false);
		$('#slStock option[value!=""]').remove();
		for(var i=0;i<stocks.length ;i++)
		{
			stock = stocks[i];
			option = $("<option></option>")
			option.attr("value",stock.id)
			option.text(stock.name)
			$('#slStock').append(option)
		}
		$('#slStock').chosen('destroy');
		$('#slStock').prop("selectedIndex", -1);
		$('#slStock').chosen();
		//hide loading
		$.fn.loading.hide();
		
	});
}
function clearVal( slName ){
	
	if(slName == "dept")
	{
		$('#slSerial').prop("disabled", true);
		$('#slSerial option[value!=""]').remove();
		$("#slSerial").prop("selectedIndex", -1).chosen('destroy').chosen();
	}
	$("#slState").prop("selectedIndex", -1).chosen('destroy').chosen();
	$("#txtAssetID").val('');
	$("#txtInterval").val('');
	$("#remain-amount").val('');
	$("#hd_cus_amount").val('');
	$("#txtNote").val('');
}
jQuery(window).load(function(){
	$(".numberic").numeric({ negative : false });
	$("form:not(.filter) :input:visible:enabled:first").focus();
});
</script>
{% endblock scripts%}